<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Bus Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 10; background-color: #e5e7eb; }
        .leaflet-control-attribution, .leaflet-control-zoom { display: none; }
        .pulse { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 12px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Map View -->
    <div id="map"></div>

    <!-- Top Info Panel -->
    <div class="absolute top-4 left-1/2 -translate-x-1/2 z-20 w-11/12 max-w-md">
        <div class="bg-white rounded-xl shadow-2xl p-4 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-bold text-gray-800">Live Bus Tracker</h1>
                    <p class="text-xs text-gray-500">Bus ID: <span id="bus-id" class="font-medium">BUS-42</span></p>
                </div>
                <div id="status-display" class="text-right">
                    <div class="flex items-center justify-end space-x-2">
                        <span id="status-indicator" class="h-3 w-3 rounded-full bg-gray-400 transition-colors"></span>
                        <span id="status-text" class="text-sm font-semibold text-gray-600">Initializing...</span>
                    </div>
                    <p id="last-update" class="text-xs text-gray-400 mt-1">Awaiting signal...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Simulator Controls Panel -->
    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 w-11/12 max-w-md">
        <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-2xl p-4 border border-gray-200 text-center">
            <h2 class="font-bold text-gray-700 mb-2">Bus Simulator</h2>
            <p id="sim-status" class="text-sm text-gray-600 mb-4">Press 'Start' to see the tracker in action.</p>
            <div class="flex justify-center space-x-4">
                <button id="start-sim-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">Start</button>
                <button id="stop-sim-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Stop</button>
            </div>
        </div>
    </div>

    <!-- Error Overlay -->
    <div id="error-overlay" class="hidden absolute inset-0 z-30 bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 border-4 border-red-300 max-w-sm text-center">
            <h2 class="text-xl font-bold text-red-600 mb-2">Connection Failed</h2>
            <p class="text-gray-700 mb-4">The app could not connect to the backend. This is usually caused by an incorrect Firebase configuration.</p>
            <p class="text-sm text-gray-500">Go to your Firebase project, copy the configuration object, and paste it into the `index.html` file.</p>
            <pre id="error-details" class="mt-4 text-left bg-gray-100 p-2 rounded text-xs text-red-800 overflow-auto font-mono"></pre>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =============================================================
        //  IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
        // =============================================================
        // To get this, go to your Firebase project console:
        // Project Overview -> Project settings (gear icon) -> General tab
        // Scroll down to "Your apps", select your web app, and find the "Firebase SDK snippet".
        // Choose the "Config" option and copy the entire object.
        const firebaseConfig = {
            apiKey: "AIzaSyAySXFbhyajAE7qcSyjGRcbF8jejG2GAFw",
            authDomain: "appify-3b358.firebaseapp.com",
            projectId: "appify-3b358",
            storageBucket: "appify-3b358.appspot.com",
            messagingSenderId: "1040554600495",
            appId: "1:1040554600495:web:71afd390d47d562a333eda",
            measurementId: "G-4WH3BW00XN"
        };
        // =============================================================

        // --- Global Variables ---
        const busId = "BUS-42";
        let db;
        let map = null;
        let busMarker = null;
        let simulatorIntervalId = null;
        let currentSimCoords = { lat: 26.1445, lng: 91.7362 }; // Starting point: Guwahati, India

        // --- UI Elements ---
        const statusText = document.getElementById('status-text');
        const statusIndicator = document.getElementById('status-indicator');
        const lastUpdate = document.getElementById('last-update');
        const startSimBtn = document.getElementById('start-sim-btn');
        const stopSimBtn = document.getElementById('stop-sim-btn');
        const simStatus = document.getElementById('sim-status');
        const errorOverlay = document.getElementById('error-overlay');
        const errorDetails = document.getElementById('error-details');

        // --- Main App Initialization ---
        async function initApp() {
            try {
                statusText.textContent = 'Connecting...';
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);
                console.log("Firebase Authenticated Anonymously.");
                
                initMapView();
                listenForBusLocation();
                setupSimulatorControls();
                
            } catch (error) {
                console.error("CRITICAL: Firebase Init or Auth Failed!", error);
                statusText.textContent = 'Connection Failed';
                lastUpdate.textContent = 'See error details.';
                errorOverlay.classList.remove('hidden');
                errorDetails.textContent = `Error Code: ${error.code}\nMessage: ${error.message}`;
            }
        }

        // --- Map Initialization ---
        function initMapView() {
            if (map) return;
            map = L.map('map').setView([currentSimCoords.lat, currentSimCoords.lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            statusText.textContent = 'Listening...';
        }

        // --- Firestore Listener ---
        function listenForBusLocation() {
            const busRef = doc(db, "buses", busId);
            onSnapshot(busRef, (doc) => {
                const data = doc.exists() ? doc.data() : null;
                updateUI(data);
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                statusText.textContent = 'Sync Error';
                statusIndicator.className = 'h-3 w-3 rounded-full bg-orange-500';
            });
        }
        
        // --- Central UI Update Function ---
        function updateUI(data) {
            if (data && data.status === 'en-route' && data.lat && data.lng) {
                statusText.textContent = 'En Route';
                statusIndicator.className = 'h-3 w-3 rounded-full bg-green-500 pulse';
                if (data.lastUpdate?.toDate) {
                    lastUpdate.textContent = `Updated: ${data.lastUpdate.toDate().toLocaleTimeString()}`;
                }

                const newPosition = [data.lat, data.lng];
                const busIcon = L.icon({
                    iconUrl: 'https://placehold.co/48x48/facc15/1f2937?text=ðŸšŒ&font=inter',
                    iconSize: [40, 40], iconAnchor: [20, 20],
                });

                if (!busMarker) {
                    busMarker = L.marker(newPosition, { icon: busIcon }).addTo(map);
                    map.setView(newPosition, 16);
                } else {
                    busMarker.setLatLng(newPosition);
                    map.panTo(newPosition, { animate: true, duration: 1 });
                }
            } else {
                statusText.textContent = 'Offline';
                statusIndicator.className = 'h-3 w-3 rounded-full bg-red-500';
                if (data?.lastUpdate?.toDate) {
                     lastUpdate.textContent = `Last seen: ${data.lastUpdate.toDate().toLocaleTimeString()}`;
                } else {
                     lastUpdate.textContent = 'Waiting for bus to start trip.';
                }
            }
        }
        
        // --- Simulator Logic ---
        function setupSimulatorControls() {
            startSimBtn.addEventListener('click', startSimulator);
            stopSimBtn.addEventListener('click', stopSimulator);
        }

        function startSimulator() {
            startSimBtn.disabled = true;
            stopSimBtn.disabled = false;
            simStatus.textContent = "Simulation is running. Watch the map!";
            updateSimulatedLocation(); 
            simulatorIntervalId = setInterval(updateSimulatedLocation, 3000); // Update every 3 seconds
        }

        async function stopSimulator() {
            startSimBtn.disabled = false;
            stopSimBtn.disabled = true;
            simStatus.textContent = "Simulation stopped. Press 'Start' to run again.";

            if (simulatorIntervalId) clearInterval(simulatorIntervalId);
            simulatorIntervalId = null;
            
            try {
                await setDoc(doc(db, "buses", busId), { 
                    status: 'offline',
                    lastUpdate: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error("Error setting bus to offline:", error);
            }
        }
        
        async function updateSimulatedLocation() {
            currentSimCoords.lat += (Math.random() - 0.5) * 0.001;
            currentSimCoords.lng += (Math.random() - 0.5) * 0.001;
            const busData = {
                lat: currentSimCoords.lat,
                lng: currentSimCoords.lng,
                status: 'en-route',
                lastUpdate: serverTimestamp()
            };
            try {
                await setDoc(doc(db, "buses", busId), busData);
            } catch (error) {
                console.error("Firestore Write Error (Simulator):", error);
                stopSimulator();
            }
        }

        // --- Start the App on DOM Load ---
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

